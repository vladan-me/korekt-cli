image: atlassian/default-image:5  # Ubuntu 24.04 with Node.js 22.15.0, jq, git, and other tools

# Required Repository Variables (Settings â†’ Repository variables):
#   KOREKT_API_KEY - Your Korekt API key
#   BITBUCKET_ACCESS_TOKEN - App password with PR write permissions

definitions:
  steps:
    - step: &korekt-review
        name: AI Code Review
        clone:
          depth: full  # Full git history for accurate diff
        caches:
          - node
        script:
          - npm install -g korekt-cli
          - git fetch origin "$BITBUCKET_PR_DESTINATION_BRANCH"
          - kk review "origin/$BITBUCKET_PR_DESTINATION_BRANCH" --comment

pipelines:
  pull-requests:
    '**':  # Run on all PRs
      - step: *korekt-review

  # Optional: Review on specific branches (non-PR, no comments posted)
  branches:
    feature/**:
      - step:
          name: Feature Branch Review
          clone:
            depth: full
          script:
            - npm install -g korekt-cli
            - kk review origin/develop --json > results.json
            - |
              if [ -f results.json ]; then
                TOTAL=$(jq -r '.data.summary.total_issues // 0' results.json)
                echo "Review found $TOTAL issue(s)"
              fi
          trigger: manual  # Only run when manually triggered
          artifacts:
            - results.json

# Alternative configuration for specific target branches only
# pipelines:
#   pull-requests:
#     develop:
#       - step: *korekt-review
#     main:
#       - step: *korekt-review
