trigger:
  branches:
    exclude:
      - '*'  # Don't trigger on direct pushes

pr:
  branches:
    include:
      - main
      - master
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '20.x'

stages:
  - stage: CodeReview
    displayName: 'AI Code Review'
    jobs:
      - job: KorektReview
        displayName: 'Run Korekt Review'
        steps:
          - checkout: self
            fetchDepth: 0  # Full git history
            fetchTags: false  # Skip tags for performance

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: npm install -g korekt-cli
            displayName: 'Install korekt-cli'

          - script: kk config --key "$(KOREKT_API_KEY)"
            displayName: 'Configure korekt'
            env:
              KOREKT_API_KEY: $(KOREKT_API_KEY)

          - script: |
              echo "Target branch: $(System.PullRequest.TargetBranch)"
              # Remove 'refs/heads/' prefix from branch name
              TARGET_BRANCH=$(echo "$(System.PullRequest.TargetBranch)" | sed 's|refs/heads/||')
              echo "Cleaned target branch: $TARGET_BRANCH"
              # Fetch target branch explicitly
              git fetch origin "$TARGET_BRANCH"
              # Run review with JSON output
              kk review "origin/$TARGET_BRANCH" --json > results.json
            displayName: 'Run AI Code Review'

          - script: |
              kk get-script azure | bash -s results.json
            displayName: 'Post PR Comment'
            condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
            env:
              SYSTEM_ACCESSTOKEN: $(System.AccessToken)
              SYSTEM_TEAMFOUNDATIONCOLLECTIONURI: $(System.TeamFoundationCollectionUri)
              SYSTEM_TEAMPROJECT: $(System.TeamProject)
              BUILD_REPOSITORY_ID: $(Build.Repository.ID)
              SYSTEM_PULLREQUEST_PULLREQUESTID: $(System.PullRequest.PullRequestId)
              BUILD_BUILDID: $(Build.BuildId)

          - task: PublishBuildArtifacts@1
            displayName: 'Upload Review Results'
            condition: always()
            inputs:
              PathtoPublish: 'results.json'
              ArtifactName: 'korekt-review-results'
              publishLocation: 'Container'

          # Optional: Fail if critical issues found
          # - script: |
          #     CRITICAL=$(jq -r '.data.summary.critical // 0' results.json)
          #     if [ "$CRITICAL" -gt "0" ]; then
          #       echo "##vso[task.logissue type=error]Found $CRITICAL critical issue(s)"
          #       exit 1
          #     fi
          #   displayName: 'Check for Critical Issues'
          #   condition: always()
